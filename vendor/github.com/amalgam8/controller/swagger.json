{
  "swagger" : "2.0",
  "info" : {
    "title" : "Controller API for Amalgam8",
    "description": "The controller monitors the registry and updates the sidecar configuration accordingly. It provides APIs to the developer for configuring rules for request routing, fault injection, etc. These rules are then translated and sent to the sidecars belonging to the application.",
    "version" : "0.2"
  },
  "schemes" : [ "https" ],
  "consumes" : [ "application/json" ],
  "produces" : [ "application/json" ],
  "paths" : {
    "/health" : {
      "parameters" : [ ],
      "get" : {
        "tags" : [ ],
        "summary" : "Status of the controller",
        "description" : "Returns status of the controller",
        "responses" : {
          "200" : {
            "description" : "Controller is healthy"
          },
          "503": {
            "description" : "Controller is unhealthy"
          }
        }
      }
    },
    "/v1/poll" : {
      "parameters" : [
        {
          "name": "token",
          "in": "header",
          "description": "Tenant token",
          "type": "string",
          "required": true
        }
      ],
      "post" : {
        "tags" : [ ],
        "summary" : "Poll for changes in registries",
        "description" : "Performs a poll of the registry for each registered tenant and checks for changes",
        "parameters" : [ ],
        "responses" : {
          "200" : {
            "description" : "Successfully polled registries for all tenants"
          },
          "500" : {
            "description" : "Failed to poll registries for one or more tenants"
          }
        }
      }
    },
    "/v1/tenants" : {
      "parameters" : [
        {
          "name": "token",
          "in": "header",
          "description": "Tenant token",
          "type": "string",
          "required": true
        }
      ],
      "post" : {
        "tags" : [ ],
        "summary" : "Register a tenant",
        "description" : "Registers a tenant with the controller",
        "parameters" : [
          {
            "name": "token",
            "in": "header",
            "description": "Tenant token",
            "type": "string",
            "required": true
          },
          {
            "name": "tenant",
            "in": "body",
            "description": "Tenant information",
            "schema": {
              "$ref": "#/definitions/tenant"
            },
            "required": true
          }
        ],
        "responses" : {
          "201" : {
            "description" : "Tenant registered"
          },
          "400" : {
            "description" : "Invalid request"
          },
          "409" : {
            "description" : "Tenant already registered"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      },
      "get" : {
        "tags" : [ ],
        "summary" : "Credentials and configuration of a tenant",
        "description" : "Returns the credentials and configuration of a tenant",
        "responses" : {
          "200" : {
            "description" : "Tenant information",
            "schema" : {
              "$ref" : "#/definitions/tenant"
            }
          },
          "404" : {
            "description" : "No information exists for tenant ID"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      },
      "put" : {
        "tags" : [ ],
        "summary" : "Update tenant information",
        "description" : "Updates the credentials and configuration of a tenant",
        "parameters" : [
          {
            "name": "tenant_info",
            "in": "body",
            "description": "Information to update",
            "schema": {
              "$ref": "#/definitions/tenant"
            },
            "required": true
          }
        ],
        "responses" : {
          "200" : {
            "description" : "Tenant info successfully updated"
          },
          "400" : {
            "description" : "Malformed JSON in request"
          },
          "404" : {
            "description" : "No information exists for tenant ID"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      },
      "delete" : {
        "tags" : [ ],
        "summary" : "Unregisters a tenant",
        "description" : "Unregisters a tenant",
        "parameters" : [ ],
        "responses" : {
          "200" : {
            "description" : "Tenant successfully deleted"
          },
          "404" : {
            "description" : "No information exists for tenant ID"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      }
    },
    "/v1/nginx" : {
      "parameters" : [
        {
          "name": "token",
          "in": "header",
          "description": "Tenant token",
          "type": "string",
          "required": true
        }
      ],
      "get" : {
        "produces" : [ "text/plain" ],
        "tags" : [ ],
        "summary" : "Proxy configuration of a tenant",
        "description" : "Returns the proxy configuration for a given tenant",
        "parameters" : [ ],
        "responses" : {
          "200" : {
            "description" : "Proxy configuration of tenant",
            "schema" : {
              "$ref" : "#/definitions/nginx"
            }
          },
          "204" : {
            "description" : "No configuration changes"
          },
          "404" : {
            "description" : "No information exists for tenant ID"
          },
          "500" : {
            "description" : "Error generating configuration"
          },
          "503" : {
            "description" : "Error communicating with external service"
          }
        }
      }
    },
    "/v1/rules" : {
      "parameters" : [
        {
          "name": "token",
          "in": "header",
          "description": "Tenant token",
          "type": "string",
          "required": true
        }
      ],
      "get" : {
        "tags" : [ ],
        "summary" : "Gets rules for a tenant",
        "description" : "Gets rules for a given tenant. If query parameters are provided, the results are filtered based on the query parameters. Otherwise all rules for a given tenant are returned. Query parameters can be repeated to query for multiple rules.",
        "parameters" : [
          {
            "name": "id",
            "in": "query",
            "description": "Rule ID",
            "required": false,
            "type": "array",
            "items": {
              "type": "string"
            },
            "collectionFormat": "multi"
          }
        ],
        "responses" : {
          "200" : {
            "description" : "Successfully retrieved rules",
            "schema" : {
              "$ref" : "#/definitions/rules"
            }
          },
          "404" : {
            "description" : "One or more rule was not found"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      },

      "post" : {
        "summary" : "Adds rules to a tenant",
        "description" :"Adds rules to a tenant. Rules are added transactionally; on a failure, no rules are added.",
        "parameters" : [
          {
            "name": "rules",
            "in": "body",
            "description": "Rules",
            "schema": {
              "$ref": "#/definitions/rules"
            },
            "required": true
          }
        ],
        "responses" : {
          "200" : {
            "description" : "Successfully created rules",
            "schema" : {
              "$ref" : "#/definitions/in_rules"
            }
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      },

      "delete" : {
        "summary" : "Removes rules from a tenant",
        "description" : "Removes rules from a tenant. Rules are removed transactionally; on a failure, no rules are removed. If query parameters are provided, only rules matching the parameters will be removed. If no query parameters are provided, all rules are removed",
        "parameters" : [
          {
            "name": "id",
            "in": "query",
            "description": "Rule ID",
            "required": false,
            "type": "array",
            "items": {
              "type": "string"
            },
            "collectionFormat": "multi"
          }
        ],
        "responses" : {
          "200" : {
            "description" : "Successfully removed rules"
          },
          "404" : {
            "description" : "One or more rule was not found"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      }
    },

    "/v1/versions/{service}" : {
      "parameters" : [
        {
          "name": "token",
          "in": "header",
          "description": "Tenant token",
          "type": "string",
          "required": true
        },
        {
          "name": "service",
          "in": "path",
          "description": "Service Name",
          "type": "string",
          "required": true
        }
      ],
      "get" : {
        "tags" : [ ],
        "summary" : "Returns the service version rules for a tenant",
        "description" : "Returns the version filter for a tenant for a service",
        "parameters" : [ ],
        "responses" : {
          "200" : {
            "description" : "Successfully retrieved version filter",
            "schema" : {
              "$ref" : "#/definitions/version"
            }
          },
          "404" : {
            "description" : "No information exists for tenant ID or service name"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      },
      "put" : {
        "tags" : [ ],
        "summary" : "Create a service version filter for a tenant",
        "description" : "Creates a version filter for a tenant for a service",
        "parameters" : [
          {
            "name": "version",
            "in": "body",
            "description": "New version filter for tenant",
            "schema": {
              "$ref": "#/definitions/version"
            },
            "required": true
          }
        ],
        "responses" : {
          "200" : {
            "description" : "Successfully created version filter"
          },
          "400" : {
            "description" : "Missing or invalid JSON"
          },
          "404" : {
            "description" : "No information exists for tenant ID"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      },
      "delete" : {
        "tags" : [ ],
        "summary" : "Delete the service version filter for a tenant",
        "description" : "Deletes the service version filter for a tenant",
        "parameters" : [ ],
        "responses" : {
          "200" : {
            "description" : "Successfully deleted version filter"
          },
          "404" : {
            "description" : "No information exists for tenant ID or service name"
          },
          "503" : {
            "description" : "Error communicating with database"
          }
        }
      }
    }
  },
  "definitions" : {
    "tenant" : {
      "properties" : {
        "id" : {
          "type" : "string",
          "description" : "ID of tenant"
        },
        "port" : {
          "type" : "integer",
          "description" : "NGINX port"
        },
        "load_balance" : {
          "type" : "string",
          "description" : "Load balancing algorithm for tenant"
        },
        "credentials" : {
          "$ref" : "#/definitions/credentials"
        },
        "filters" : {
          "$ref" : "#/definitions/filter"
        }
      }
    },
    "credentials" : {
      "properties" : {
        "kafka" : {
          "$ref" : "#/definitions/kafka"
        },
        "registry" : {
          "$ref" : "#/definitions/registry"
        }
      }
    },
    "registry" : {
      "properties" : {
        "url" : {
          "type" : "string",
          "description" : "url for registry"
        },
        "token" : {
          "type" : "string",
          "description" : "token for registry"
        }
      }
    },
    "kafka" : {
      "properties" : {
        "api_key" : {
          "type" : "string",
          "description" : "token for kafka REST API"
        },
        "admin_url" : {
          "type" : "string",
          "description" : "kafka admin url"
        },
        "rest_url" : {
          "type" : "string",
          "description" : "kafka REST url"
        },
        "brokers" : {
          "type" : "array",
          "description" : "kafka brokers",
          "items" : {
            "type" : "string"
          }
        },
        "user" : {
          "type" : "string",
          "description" : "username for SASL authentication"
        },
        "password" : {
          "type" : "string",
          "description" : "password for SASL authentication"
        },
        "sasl" : {
          "type" : "boolean",
          "description" : "enable or disable SASL authentication"
        }
      }
    },
    "filter" : {
      "properties" : {
        "rules" : {
          "type" : "array",
          "description" : "delay filters for tenant",
          "items" : {
            "$ref" : "#/definitions/rule"
          }
        },
        "versions" : {
          "type" : "array",
          "description" : "abort filters for tenant",
          "items" : {
            "$ref" : "#/definitions/version"
          }
        }
      }
    },
    "in_rules" : {
      "properties": {
        "rules" : {
          "type" : "array",
          "description" : "rules",
          "items" : {
            "$ref" : "#/definitions/in_rule"
          }
        }
      }
    },
    "in_rule" : {
      "properties" : {
        "source" : {
          "type" : "string",
          "description" : "Service name of request source"
        },
        "destination" : {
          "type" : "string",
          "description" : "Service name of request destination"
        },
        "pattern" : {
          "type" : "string",
          "description" : "Header pattern"
        },
        "delay" : {
          "type" : "number",
          "description" : "Delay in seconds"
        },
        "delay_probability" : {
          "type" : "number",
          "description" : "Delay probability in range [0.0, 1.0]"
        },
        "abort_probability" : {
          "type" : "number",
          "description" : "Abort probability in range [0.0, 1.0]"
        },
        "return_code" : {
          "type" : "integer",
          "description" : "Failure code returned by abort"
        }
      }
    },
    "rules" : {
      "properties": {
        "rules" : {
          "type" : "array",
          "description" : "rules",
          "items" : {
            "$ref" : "#/definitions/rule"
          }
        }
      }
    },
    "rule" : {
      "properties" : {
        "id" : {
          "type" : "string",
          "description" : "Rule ID"
        },
        "source" : {
          "type" : "string",
          "description" : "Service name of request source"
        },
        "destination" : {
          "type" : "string",
          "description" : "Service name of request destination"
        },
        "header" : {
          "type" : "string",
          "description" : "Header name"
        },
        "pattern" : {
          "type" : "string",
          "description" : "Header pattern"
        },
        "delay" : {
          "type" : "number",
          "description" : "Delay in seconds"
        },
        "delay_probability" : {
          "type" : "number",
          "description" : "Delay probability in range [0.0, 1.0]"
        },
        "abort_probability" : {
          "type" : "number",
          "description" : "Abort probability in range [0.0, 1.0]"
        },
        "return_code" : {
          "type" : "integer",
          "description" : "Failure code returned by abort"
        }
      }
    },
    "version" : {
      "properties" : {
        "service" : {
          "type" : "string",
          "description" : "Service to apply versioning to"
        },
        "default" : {
          "type" : "string",
          "description" : "Default Service version to use"
        },
        "selector" : {
          "type" : "object",
          "description" : "Version selector"
        }
      }
    },
    "nginx" : {
      "properties" : {
        "upstreams" : {
          "type" : "array",
          "description" : "Service upstreams",
          "items" : {
            "$ref" : "#/definitions/upstream"
          }
        },
        "services" : {
          "type" : "array",
          "description" : "Service version info",
          "items" : {
            "$ref" : "#/definitions/service"
          }
        },
        "faults" : {
          "type" : "array",
          "description" : "Service faults",
          "items" : {
            "$ref" : "#/definitions/rule"
          }
        }
      }
    },
    "service" : {
      "properties" : {
        "default" : {
          "type" : "string",
          "description" : "Default version of service to use"
        },
        "selectors" : {
          "type" : "string",
          "description" : "Selectors to use for choosing which version of service to use"
        },
        "type" : {
          "type" : "string",
          "description" : "Endpoint type of service http/https/tcp/udp"
        }
      }
    },
    "upstream" : {
      "properties" : {
        "servers" : {
          "type" : "array",
          "description" : "",
          "items" : {
            "$ref" : "#/definitions/endpoint"
          }
        }
      }
    },
    "endpoint" : {
      "properties" : {
        "host" : {
          "type" : "string",
          "description" : "Service instance hostname or IP"
        },
        "port" : {
          "type" : "number",
          "description" : "Service instance port"
        }
      }
    }
  }
}
